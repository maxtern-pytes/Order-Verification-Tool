<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if view == 'packed' %}Packed Orders{% else %}Orders to Pack{% endif %} - Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
    <script>
        // Use a JS constant for the view to keep the IDE happy
        const CURRENT_VIEW = '{{ view or "confirmed" }}';

        // Bulk delete functions
        function toggleSelectAll() {
            const selectAll = document.getElementById('select_all');
            const checkboxes = document.querySelectorAll('.order-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
            updateBulkActions();
        }

        function updateBulkActions() {
            const checkboxes = document.querySelectorAll('.order-checkbox:checked');
            const bulkActions = document.getElementById('bulk_actions');
            const selectedCount = document.getElementById('selected_count');

            if (checkboxes.length > 0) {
                bulkActions.classList.remove('hidden');
                selectedCount.textContent = checkboxes.length;
            } else {
                bulkActions.classList.add('hidden');
            }
        }

        function deleteSelected() {
            const checkboxes = document.querySelectorAll('.order-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('Please select orders to delete');
                return;
            }

            if (!confirm(`Are you sure you want to delete ${checkboxes.length} order(s)?`)) {
                return;
            }

            const orderIds = Array.from(checkboxes).map(cb => cb.value);

            fetch('/bulk_delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ order_ids: orderIds })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.reload();
                    } else {
                        alert('Error deleting orders');
                    }
                });
        }

        function clearAll() {
            if (!confirm('Are you sure you want to delete ALL orders in this view? This cannot be undone!')) {
                return;
            }

            fetch('/clear_all?view=' + CURRENT_VIEW, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.reload();
                    } else {
                        alert('Error clearing orders');
                    }
                });
        }

        function exportToExcel() {
            if (CURRENT_VIEW === 'packed') {
                window.location.href = '/export/packed';
            } else {
                window.location.href = '/export/confirmed';
            }
        }

        function markAsPacked(orderId) {
            if (!confirm('Mark this order as packed?')) {
                return;
            }

            const formData = new FormData();
            formData.append('order_id', orderId);

            fetch('/mark_packed', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.reload();
                    } else {
                        alert('Error marking order as packed');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error marking order as packed');
                });
        }
    </script>
</head>

<body class="bg-gray-50">
    <div class="min-h-screen p-4 md:p-8">
        <!-- Header -->
        <header class="bg-white rounded-lg shadow-sm p-4 md:p-6 mb-6">
            <div class="flex flex-col gap-4">
                <!-- Title and Tabs -->
                <div class="flex flex-col gap-4">
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-900">üì¶ Order Viewer</h1>

                    <!-- Tabs -->
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8">
                            <a href="/viewer"
                                class="{% if view == 'confirmed' or not view %}border-blue-500 text-blue-600{% else %}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{% endif %} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                                ‚úÖ To Pack ({{ orders|length }})
                            </a>
                            <a href="/viewer/packed"
                                class="{% if view == 'packed' %}border-green-500 text-green-600{% else %}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{% endif %} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                                üì¶ Packed Orders
                            </a>
                        </nav>
                    </div>
                </div>

                <!-- Export and Actions -->
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div class="flex flex-col md:flex-row gap-3">
                        <input type="date" id="start_date" value="{{ start_date or '' }}"
                            class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <input type="date" id="end_date" value="{{ end_date or '' }}"
                            class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <button onclick="exportToExcel()"
                            class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                </path>
                            </svg>
                            Export Excel
                        </button>
                    </div>
                </div>

                <!-- Bulk Actions -->
                <div class="flex items-center justify-between border-t pt-4">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="select_all" onchange="toggleSelectAll()"
                            class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                        <label for="select_all" class="text-sm font-medium text-gray-700">Select All</label>
                    </div>
                    <div id="bulk_actions" class="flex items-center gap-2 hidden">
                        <span class="text-sm text-gray-600">Selected: <span id="selected_count"
                                class="font-bold">0</span></span>
                        <button onclick="deleteSelected()"
                            class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-medium transition-colors">
                            Delete Selected
                        </button>
                    </div>
                    <button onclick="clearAll()"
                        class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-medium transition-colors">
                        üóëÔ∏è Clear All Orders
                    </button>
                </div>
            </div>

            <!-- Filters Section -->
            <div class="bg-gray-50 rounded-lg p-4 mt-4">
                <form method="GET" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Start Date</label>
                        <input type="date" name="start_date" value="{{ start_date or '' }}"
                            class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">End Date</label>
                        <input type="date" name="end_date" value="{{ end_date or '' }}"
                            class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Payment</label>
                        <select name="payment" class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm">
                            <option value="">All</option>
                            <option value="Prepaid" {{ 'selected' if payment=='Prepaid' }}>Prepaid</option>
                            <option value="COD" {{ 'selected' if payment=='COD' }}>COD</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Delivery</label>
                        <select name="delivery" class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm">
                            <option value="">All</option>
                            <option value="Standard" {{ 'selected' if delivery=='Standard' }}>Standard</option>
                            <option value="Express" {{ 'selected' if delivery=='Express' }}>Express</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">State</label>
                        <select name="state" class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm">
                            <option value="">All</option>
                            <option value="Delhi" {{ 'selected' if state=='Delhi' }}>Delhi</option>
                            <option value="Maharashtra" {{ 'selected' if state=='Maharashtra' }}>Maharashtra</option>
                            <option value="Karnataka" {{ 'selected' if state=='Karnataka' }}>Karnataka</option>
                            <option value="Tamil Nadu" {{ 'selected' if state=='Tamil Nadu' }}>Tamil Nadu</option>
                            <option value="Gujarat" {{ 'selected' if state=='Gujarat' }}>Gujarat</option>
                            <option value="Rajasthan" {{ 'selected' if state=='Rajasthan' }}>Rajasthan</option>
                            <option value="West Bengal" {{ 'selected' if state=='West Bengal' }}>West Bengal</option>
                            <option value="Telangana" {{ 'selected' if state=='Telangana' }}>Telangana</option>
                            <option value="Haryana" {{ 'selected' if state=='Haryana' }}>Haryana</option>
                            <option value="Punjab" {{ 'selected' if state=='Punjab' }}>Punjab</option>
                        </select>
                    </div>
                    <div class="md:col-span-2 lg:col-span-5 flex gap-2">
                        <button type="submit"
                            class="px-4 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm font-medium">
                            Apply Filters
                        </button>
                        <a href="/viewer"
                            class="px-4 py-1.5 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded text-sm font-medium">
                            Clear
                        </a>
                    </div>
                </form>
            </div>
        </header>

        <!-- Orders Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for order in orders %}
            <div class="bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow overflow-hidden relative">
                <!-- Checkbox for bulk delete -->
                <div class="absolute top-3 left-3 z-10">
                    <input type="checkbox" value="{{ order.id }}"
                        class="order-checkbox w-5 h-5 text-blue-600 rounded focus:ring-blue-500"
                        onchange="updateBulkActions()">
                </div>
                <!-- Header -->
                <div class="p-5 border-b border-gray-100 flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex gap-2 mb-2 flex-wrap">
                            <span
                                class="inline-block px-2 py-0.5 rounded text-xs font-semibold
                                {% if order.source == 'Shopify' %} bg-green-100 text-green-700 {% else %} bg-purple-100 text-purple-700 {% endif %}">
                                {{ order.source }}
                            </span>
                            <span
                                class="inline-block px-2 py-0.5 rounded text-xs font-semibold
                                {% if order.delivery_type == 'Express' %} bg-purple-100 text-purple-700 border border-purple-200 {% else %} bg-gray-100 text-gray-600 border border-gray-200 {% endif %}">
                                üöö {{ order.delivery_type or 'Standard' }}
                            </span>
                            <span class="inline-block px-2 py-0.5 rounded text-xs font-bold uppercase
                                {% if order.rto_risk == 'HIGH' %} bg-red-100 text-red-700 border border-red-300 
                                {% elif order.rto_risk == 'MEDIUM' %} bg-orange-100 text-orange-700 border border-orange-300 
                                {% else %} bg-green-100 text-green-700 border border-green-300 {% endif %}">
                                ‚ö†Ô∏è RTO: {{ order.rto_risk or 'LOW' }}
                            </span>
                        </div>
                        <h3 class="font-bold text-lg">{{ order.customer_name }}</h3>
                        {% if order.email %}
                        <p class="text-xs text-gray-600">üìß {{ order.email }}</p>
                        {% endif %}
                        <p class="text-xs text-gray-500">ID: {{ order.id }}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-gray-900">‚Çπ{{ order.total }}</p>
                        <span
                            class="inline-block px-2 py-0.5 rounded text-[10px] font-bold uppercase mt-1
                            {% if order.payment_method == 'Prepaid' %} bg-blue-100 text-blue-700 {% else %} bg-gray-200 text-gray-700 {% endif %}">
                            {{ order.payment_method or 'COD' }}
                        </span>
                        <p class="text-xs text-gray-400 mt-1">{{ order.timestamp }}</p>
                    </div>
                </div>

                <!-- Body -->
                <div class="p-5 space-y-4">
                    <div>
                        <p class="text-xs uppercase tracking-wide text-gray-400 mb-1">Products</p>
                        <ul class="text-sm text-gray-700 font-medium">
                            {% for item in order.products %}
                            <li class="truncate">‚Ä¢ {{ item }}</li>
                            {% else %}
                            <li class="text-gray-400 italic">No products listed</li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div>
                        <p class="text-xs uppercase tracking-wide text-gray-400 mb-1">Address</p>
                        <p class="text-sm text-gray-600 mb-1">{{ order.address or 'No Address Provided' }}</p>
                        {% if order.state %}
                        <span
                            class="inline-block px-2 py-0.5 rounded text-xs font-bold bg-yellow-100 text-yellow-800 border border-yellow-200">
                            {{ order.state }}
                        </span>
                        {% endif %}
                    </div>
                    {% if order.notes %}
                    <div class="bg-yellow-50 p-2 rounded border border-yellow-100">
                        <p class="text-xs uppercase tracking-wide text-yellow-600 mb-1 font-bold">üìù Notes</p>
                        <p class="text-sm text-gray-700">{{ order.notes }}</p>
                    </div>
                    {% endif %}
                    <div class="flex items-center justify-between bg-blue-50 p-3 rounded-lg">
                        <span class="font-mono text-blue-900 font-medium">{{ order.phone }}</span>
                        <a href="tel:{{ order.phone }}"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-md text-sm font-medium transition-colors">
                            Call
                        </a>
                    </div>

                    <!-- Mark as Packed Button (only show in To Pack tab) -->
                    {% if view != 'packed' %}
                    <button onclick="markAsPacked('{{ order.id }}')"
                        class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7">
                            </path>
                        </svg>
                        Mark as Packed
                    </button>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="col-span-full text-center py-12">
                <p class="text-gray-400 text-lg">{% if view == 'packed' %}No packed orders{% else %}No orders to pack{%
                    endif %}</p>
                <p class="text-gray-500 text-sm mt-2">{% if view == 'packed' %}Orders marked as packed will appear
                    here{% else %}All confirmed orders have been packed{% endif %}</p>
            </div>
            {% endfor %}
        </div>
    </div>
</body>

</html>